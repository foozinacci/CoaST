<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CoAST – Calculator of all Structural Tuning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-panel: #0b1220;
      --bg-panel-alt: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.2);
      --danger: #f97373;
      --success: #22c55e;
      --border: #1f2937;
      --tab-bg: #020617;
      --tab-active-bg: #0f172a;
      --tab-text: #e5e7eb;
      --tab-active-text: #f9fafb;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.6);
      --radius-lg: 16px;
      --radius-pill: 999px;
      --curve-bar: #38bdf8;
      --curve-anchor: rgba(248, 250, 252, 0.1);
      --grid-border: #1f2937;
    }

    /* Light mode */
    [data-theme="light"] {
      --bg: #f3f4f6;
      --bg-panel: #ffffff;
      --bg-panel-alt: #f9fafb;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.08);
      --border: #e5e7eb;
      --tab-bg: #e5e7eb;
      --tab-active-bg: #ffffff;
      --tab-text: #374151;
      --tab-active-text: #111827;
      --curve-bar: #2563eb;
      --curve-anchor: rgba(55, 65, 81, 0.06);
      --grid-border: #e5e7eb;
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.18);
    }

    /* Neon mode */
    [data-theme="neon"] {
      --bg: #020617;
      --bg-panel: #020617;
      --bg-panel-alt: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #a855f7;
      --accent-soft: rgba(168, 85, 247, 0.18);
      --border: #4b5563;
      --tab-bg: rgba(15, 23, 42, 0.8);
      --tab-active-bg: rgba(24, 35, 75, 0.9);
      --tab-text: #e5e7eb;
      --tab-active-text: #fdf2ff;
      --curve-bar: #22c55e;
      --curve-anchor: rgba(148, 163, 184, 0.12);
      --grid-border: rgba(148, 163, 184, 0.3);
      --shadow-soft: 0 0 40px rgba(168, 85, 247, 0.45);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #0f172a 0, var(--bg) 50%, #020617 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Inter", "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 12px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .title-block h1 span.coast-a {
      text-transform: uppercase;
    }

    .title-block h1 span.coast-o {
      text-transform: lowercase;
    }

    .title-block h1 span.coast-c,
    .title-block h1 span.coast-s,
    .title-block h1 span.coast-t {
      text-transform: uppercase;
    }

    .title-block small {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .theme-toggle-group {
      display: flex;
      gap: 8px;
    }

    .theme-pill {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border);
      background: var(--tab-bg);
      color: var(--tab-text);
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease;
    }

    .theme-pill.active {
      background: var(--tab-active-bg);
      color: var(--tab-active-text);
      box-shadow: 0 0 0 1px var(--accent), var(--shadow-soft);
    }

    .theme-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
    }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: linear-gradient(145deg, var(--bg-panel), var(--bg-panel-alt));
      border-radius: 22px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 16px;
      position: relative;
      overflow: hidden;
    }

    .panel-heading {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .panel-heading h2 {
      margin: 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--muted);
    }

    .tab-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tab-pill {
      border-radius: var(--radius-pill);
      padding: 10px 18px;
      border: 1px solid var(--border);
      background: var(--tab-bg);
      color: var(--tab-text);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      transition: all 0.18s ease;
      min-width: 120px;
      justify-content: center;
    }

    .tab-pill span.small {
      font-size: 0.7rem;
      opacity: 0.7;
      text-transform: none;
      letter-spacing: normal;
    }

    .tab-pill.active {
      background: var(--tab-active-bg);
      color: var(--tab-active-text);
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft), var(--shadow-soft);
      transform: translateY(-1px);
    }

    .tab-pill:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .builder-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      padding: 10px 12px;
      resize: vertical;
    }

    [data-theme="light"] textarea {
      background: #f9fafb;
      color: var(--text);
    }

    [data-theme="neon"] textarea {
      background: radial-gradient(circle at top left, #111827, #020617 70%);
      border-color: rgba(148, 163, 184, 0.5);
    }

    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .button-primary {
      border-radius: var(--radius-pill);
      border: none;
      background: radial-gradient(circle at top left, var(--accent), #0ea5e9);
      color: white;
      padding: 10px 18px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      cursor: pointer;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.6);
      transition: transform 0.14s ease, box-shadow 0.14s ease;
    }

    .button-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
    }

    .button-secondary {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      padding: 8px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      transition: all 0.14s ease;
    }

    .button-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .status-line {
      font-size: 0.8rem;
      color: var(--muted);
      min-height: 1.2em;
    }

    .status-line.success {
      color: var(--success);
    }

    .status-line.error {
      color: var(--danger);
    }

    /* Deck view */

    .deck-tabs {
      margin-bottom: 12px;
    }

    .deck-view {
      border-radius: 18px;
      border: 1px solid var(--grid-border);
      padding: 10px;
      max-height: 460px;
      overflow: auto;
      background: rgba(15, 23, 42, 0.6);
    }

    [data-theme="light"] .deck-view {
      background: #f9fafb;
    }

    [data-theme="neon"] .deck-view {
      background: radial-gradient(circle at top, #020617, #020617 60%);
      box-shadow: 0 0 24px rgba(56, 189, 248, 0.14);
    }

    .deck-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .deck-table th,
    .deck-table td {
      border-bottom: 1px solid rgba(148, 163, 184, 0.24);
      padding: 4px 6px;
      text-align: left;
      vertical-align: middle;
    }

    .deck-table th {
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      position: sticky;
      top: 0;
      backdrop-filter: blur(6px);
      background: linear-gradient(
        to bottom,
        rgba(15, 23, 42, 0.96),
        rgba(15, 23, 42, 0.7)
      );
      z-index: 1;
    }

    [data-theme="light"] .deck-table th {
      background: linear-gradient(
        to bottom,
        rgba(249, 250, 251, 0.98),
        rgba(249, 250, 251, 0.8)
      );
    }

    [data-theme="neon"] .deck-table th {
      background: linear-gradient(
        to bottom,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.8)
      );
    }

    .qty-control {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .qty-button {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 0.75rem;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .qty-button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .qty-value {
      min-width: 1.2em;
      text-align: center;
    }

    .card-name-cell {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .card-name {
      font-weight: 500;
    }

    .card-type-pill {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      white-space: nowrap;
    }

    .land-pill {
      border-color: #22c55e;
      color: #22c55e;
    }

    .mv-chip {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.7);
      font-size: 0.7rem;
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }

    [data-theme="light"] .mv-chip {
      background: #e5e7eb;
    }

    .mv-chip span.label {
      color: var(--muted);
      font-size: 0.65rem;
    }

    .color-dots {
      display: inline-flex;
      gap: 2px;
      align-items: center;
    }

    .color-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.6);
    }

    .cW { background: #f9fafb; }
    .cU { background: #60a5fa; }
    .cB { background: #4b5563; }
    .cR { background: #f97373; }
    .cG { background: #22c55e; }
    .cC { background: #e5e7eb; }

    /* Curve graph */

    .summary-tabs {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .summary-pane {
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px;
      background: rgba(15, 23, 42, 0.6);
      font-size: 0.8rem;
    }

    [data-theme="light"] .summary-pane {
      background: #f9fafb;
    }

    [data-theme="neon"] .summary-pane {
      background: radial-gradient(circle at top, #020617, #020617 70%);
    }

    .curve-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .curve-label {
      width: 28px;
      font-size: 0.7rem;
      color: var(--muted);
      text-align: right;
    }

    .curve-bar-wrap {
      flex: 1;
      position: relative;
      height: 14px;
      border-radius: 999px;
      background: var(--curve-anchor);
      overflow: hidden;
    }

    .curve-bar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--curve-bar), #0ea5e9);
      width: 0%;
      transition: width 0.2s ease;
    }

    .curve-count {
      width: 30px;
      font-size: 0.7rem;
      text-align: right;
    }

    .summary-line {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      margin-top: 4px;
      color: var(--muted);
    }

    .summary-line strong {
      color: var(--text);
      font-weight: 500;
    }

    /* Card modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 10px;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal-card {
      background: var(--bg-panel);
      border-radius: 24px;
      border: 1px solid var(--border);
      max-width: 720px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      box-shadow: var(--shadow-soft);
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
    }

    @media (max-width: 700px) {
      .modal-card {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .modal-art {
      padding: 14px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #020617, #0b1120 60%);
    }

    .modal-art img {
      max-width: 100%;
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
    }

    .modal-body {
      padding: 16px 16px 12px;
      position: relative;
    }

    .modal-close {
      position: absolute;
      right: 12px;
      top: 10px;
      border-radius: 999px;
      width: 24px;
      height: 24px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--muted);
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.12s;
    }

    .modal-close:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .modal-body h3 {
      margin: 0 0 4px;
      font-size: 1rem;
    }

    .modal-meta {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .modal-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin: 10px 0 4px;
    }

    .modal-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.8rem;
    }

    .modal-row input {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      background: transparent;
      color: var(--text);
      font-size: 0.8rem;
      width: 80px;
    }

    .pill-label {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .footer-note {
      margin-top: 8px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .pill-tag {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 2px 8px;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .deck-footer {
      margin-top: 8px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.75rem;
      color: #e5e7eb;
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.8);
      display: none;
      align-items: center;
      gap: 6px;
      z-index: 60;
    }

    [data-theme="light"] .toast {
      background: rgba(17, 24, 39, 0.9);
    }

    [data-theme="neon"] .toast {
      box-shadow: 0 0 30px rgba(56, 189, 248, 0.5);
    }

    .toast.show {
      display: inline-flex;
    }

    .toast-icon {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--success);
    }

    .toast.error .toast-icon {
      background: var(--danger);
    }
  </style>
</head>
<body data-theme="dark">
  <div class="app-shell">
    <header>
      <div class="title-block">
        <h1>
          <span class="coast-c">C</span><span class="coast-o">o</span
          ><span class="coast-a">A</span><span class="coast-s">S</span
          ><span class="coast-t">T</span>
        </h1>
        <small>Calculator of all Structural Tuning – CoaST v2 (HTML single-file)</small>
      </div>
      <div class="theme-toggle-group">
        <button class="theme-pill active" data-theme-target="dark">
          <span class="theme-dot"></span> Dark
        </button>
        <button class="theme-pill" data-theme-target="light">
          <span class="theme-dot"></span> Light
        </button>
        <button class="theme-pill" data-theme-target="neon">
          <span class="theme-dot"></span> Neon
        </button>
      </div>
    </header>

    <div class="main-grid">
      <!-- LEFT: Import / Builder -->
      <section class="panel">
        <div class="panel-heading">
          <h2>Deck Input</h2>
        </div>

        <div class="tab-row" id="inputTabs">
          <button class="tab-pill active" data-input-tab="import">
            Import
            <span class="small">Paste decklist</span>
          </button>
          <button class="tab-pill" data-input-tab="builder">
            Builder
            <span class="small">Manual (basic)</span>
          </button>
        </div>

        <div class="builder-body" id="importTab">
          <div>
            <label class="pill-label">Paste decklist (e.g. “4 Lightning Bolt (M11) 146”):</label>
            <textarea id="deckInput" placeholder="4 Solitude (MH2) 30
3 Grief (MH2) 85
24 Plains (MIR) 331"></textarea>
          </div>
          <div class="input-row">
            <button class="button-primary" id="importButton">Import &amp; Analyze</button>
            <button class="button-secondary" id="clearButton">Clear</button>
          </div>
          <div id="status" class="status-line"></div>

          <div class="footer-note">
            What CoAST understands:
            <br />
            <code>QTY Card Name (SET) #</code> – set &amp; collector number optional.
            Alternate arts resolve via Scryfall; if an exact print isn’t found,
            CoAST falls back to a canonical printing so nothing is “unknown”.
          </div>
        </div>

        <div class="builder-body" id="builderTab" style="display:none;">
          <div class="input-row">
            <input
              type="text"
              id="builderName"
              placeholder="Card name"
              style="flex:1; border-radius:999px; border:1px solid var(--border); padding:6px 10px; background:transparent; color:var(--text); font-size:0.8rem;"
            />
            <input
              type="number"
              id="builderQty"
              value="1"
              min="1"
              style="width:80px; border-radius:999px; border:1px solid var(--border); padding:6px 10px; background:transparent; color:var(--text); font-size:0.8rem;"
            />
            <button class="button-primary" id="builderAdd">Add</button>
          </div>
          <div class="footer-note">
            This is a minimal builder: type a card name and quantity.
            CoAST will fetch mana value &amp; details from Scryfall for curve calculations.
            (Full search UI can be layered on top later.)
          </div>
        </div>
      </section>

      <!-- RIGHT: Deck view and summary -->
      <section class="panel">
        <div class="panel-heading">
          <h2>Deck View &amp; Curve</h2>
        </div>

        <div class="deck-tabs">
          <div class="tab-row">
            <button class="tab-pill active" data-view-tab="list">
              List
              <span class="small">Sortable</span>
            </button>
            <button class="tab-pill" data-view-tab="summary">
              Summary
              <span class="small">Curve / counts</span>
            </button>
          </div>
        </div>

        <div id="deckListView" class="deck-view">
          <table class="deck-table" id="deckTable">
            <thead>
              <tr>
                <th style="width:80px;">Qty</th>
                <th>Card</th>
                <th style="width:110px;">Type</th>
                <th style="width:90px;">MV</th>
                <th style="width:70px;">Colors</th>
              </tr>
            </thead>
            <tbody id="deckTableBody">
              <!-- rows injected -->
            </tbody>
          </table>
        </div>

        <div id="deckSummaryView" style="display:none;">
          <div class="summary-tabs">
            <button class="tab-pill active" data-summary-tab="curve">Curve</button>
            <button class="tab-pill" data-summary-tab="counts">Counts</button>
          </div>
          <div id="summaryCurve" class="summary-pane">
            <!-- curve graph injected -->
          </div>
          <div id="summaryCounts" class="summary-pane" style="display:none;">
            <!-- counts injected -->
          </div>
        </div>

        <div class="deck-footer" id="deckFooterInfo">
          No deck loaded yet.
        </div>
      </section>
    </div>
  </div>

  <!-- Card modal -->
  <div class="modal-backdrop" id="cardModal">
    <div class="modal-card">
      <div class="modal-art">
        <img id="modalArt" src="" alt="Card art" />
        <div id="modalPrintInfo" class="pill-label"></div>
      </div>
      <div class="modal-body">
        <button class="modal-close" id="modalCloseBtn">&times;</button>
        <h3 id="modalTitle">Card Name</h3>
        <div id="modalType" class="modal-meta"></div>

        <div class="modal-section-title">Mana Value</div>
        <div class="modal-row">
          <span class="pill-label">Rules MV:</span>
          <span id="modalRulesMV" class="pill-tag">–</span>
        </div>
        <div class="modal-row" style="margin-top:4px;">
          <span class="pill-label">Structural override:</span>
          <input type="number" id="modalMVOverride" min="0" step="1" />
          <span class="pill-label">Used for curve &amp; sorting.</span>
        </div>

        <div class="modal-section-title">Deck</div>
        <div class="modal-row">
          <span class="pill-label">Quantity in deck:</span>
          <span id="modalDeckQty" class="pill-tag">0</span>
        </div>

        <div class="footer-note">
          Clicking outside this card will save your override and close the panel.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <span class="toast-icon"></span>
    <span id="toastText"></span>
  </div>

  <script>
    // -----------------------------
    // CoAST state
    // -----------------------------
    const state = {
      cards: [], // {id, name, qty, mv, rulesMV, typeLine, colors, isLand, image, set, number}
      theme: 'dark'
    };

    const deckInput = document.getElementById('deckInput');
    const importButton = document.getElementById('importButton');
    const clearButton = document.getElementById('clearButton');
    const statusEl = document.getElementById('status');
    const deckTableBody = document.getElementById('deckTableBody');
    const deckFooterInfo = document.getElementById('deckFooterInfo');

    const deckListView = document.getElementById('deckListView');
    const deckSummaryView = document.getElementById('deckSummaryView');
    const summaryCurve = document.getElementById('summaryCurve');
    const summaryCounts = document.getElementById('summaryCounts');

    const cardModal = document.getElementById('cardModal');
    const modalArt = document.getElementById('modalArt');
    const modalPrintInfo = document.getElementById('modalPrintInfo');
    const modalTitle = document.getElementById('modalTitle');
    const modalType = document.getElementById('modalType');
    const modalRulesMV = document.getElementById('modalRulesMV');
    const modalMVOverride = document.getElementById('modalMVOverride');
    const modalDeckQty = document.getElementById('modalDeckQty');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    const toastEl = document.getElementById('toast');
    const toastText = document.getElementById('toastText');

    let modalCardId = null;
    let toastTimeout = null;

    // -----------------------------
    // Utility: toast
    // -----------------------------
    function showToast(message, isError = false) {
      toastEl.classList.remove('error', 'show');
      if (isError) toastEl.classList.add('error');
      toastText.textContent = message;
      toastEl.classList.add('show');
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toastEl.classList.remove('show');
      }, 3000);
    }

    // -----------------------------
    // Theme switching
    // -----------------------------
    document.querySelectorAll('.theme-pill').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-theme-target');
        document.body.setAttribute('data-theme', target);
        state.theme = target;
        document.querySelectorAll('.theme-pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    // -----------------------------
    // Input tab switching
    // -----------------------------
    document.querySelectorAll('[data-input-tab]').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-input-tab');
        document.querySelectorAll('[data-input-tab]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('importTab').style.display = tab === 'import' ? 'flex' : 'none';
        document.getElementById('builderTab').style.display = tab === 'builder' ? 'flex' : 'none';
      });
    });

    // -----------------------------
    // View tab switching
    // -----------------------------
    document.querySelectorAll('[data-view-tab]').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-view-tab');
        document.querySelectorAll('[data-view-tab]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        deckListView.style.display = tab === 'list' ? 'block' : 'none';
        deckSummaryView.style.display = tab === 'summary' ? 'block' : 'none';
      });
    });

    // -----------------------------
    // Summary tab switching
    // -----------------------------
    document.querySelectorAll('[data-summary-tab]').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-summary-tab');
        document.querySelectorAll('[data-summary-tab]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        summaryCurve.style.display = tab === 'curve' ? 'block' : 'none';
        summaryCounts.style.display = tab === 'counts' ? 'block' : 'none';
      });
    });

    // -----------------------------
    // Parsing
    // -----------------------------
    function parseDeckText(text) {
      const lines = text
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l.length > 0 && !l.startsWith('//'));

      const entries = [];

      const regex = /^(\d+)\s+(.+?)(?:\s+\(([A-Za-z0-9]+)\)\s+([0-9A-Za-z]+))?$/;

      for (const line of lines) {
        const m = line.match(regex);
        if (!m) {
          // Try looser: qty + name
          const simple = line.match(/^(\d+)\s+(.+)$/);
          if (simple) {
            entries.push({
              qty: parseInt(simple[1], 10),
              name: simple[2].trim(),
              set: null,
              number: null,
              raw: line
            });
          } else {
            console.warn('Unparsed line:', line);
          }
          continue;
        }
        const qty = parseInt(m[1], 10);
        const name = m[2].trim();
        const set = m[3] ? m[3].trim() : null;
        const number = m[4] ? m[4].trim() : null;

        entries.push({ qty, name, set, number, raw: line });
      }

      return entries;
    }

    // -----------------------------
    // Scryfall helpers
    // -----------------------------
    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    // Resolve a card via Scryfall in a way that tries hard not to fail.
    async function resolveCardFromScryfall(entry) {
      const name = entry.name;
      const set = entry.set;
      const number = entry.number;

      // 1) If set and collector number given, try an exact search
      if (set && number) {
        try {
          const q = encodeURIComponent(`!"${name}" set:${set.toLowerCase()} cn:${number}`);
          const url = `https://api.scryfall.com/cards/search?q=${q}&unique=prints`;
          const data = await fetchJson(url);
          if (data.total_cards > 0) {
            return data.data[0];
          }
        } catch (e) {
          console.warn('Exact set+number search failed for', entry, e);
        }
      }

      // 2) If set given, search in that set
      if (set && !number) {
        try {
          const q = encodeURIComponent(`!"${name}" set:${set.toLowerCase()}`);
          const url = `https://api.scryfall.com/cards/search?q=${q}&unique=prints`;
          const data = await fetchJson(url);
          if (data.total_cards > 0) {
            // Pick the first non-digital printing
            const nonDigital = data.data.find(c => !c.digital) || data.data[0];
            return nonDigital;
          }
        } catch (e) {
          console.warn('Set search failed for', entry, e);
        }
      }

      // 3) Named exact
      try {
        const url = `https://api.scryfall.com/cards/named?exact=${encodeURIComponent(name)}&version=png`;
        const card = await fetchJson(url);
        return card;
      } catch (e) {
        console.warn('Named search failed for', entry, e);
      }

      // 4) Last resort: fuzzy search
      try {
        const url = `https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}&version=png`;
        const card = await fetchJson(url);
        return card;
      } catch (e) {
        console.warn('Fuzzy search failed for', entry, e);
      }

      throw new Error('Unable to resolve card: ' + name);
    }

    // -----------------------------
    // Import deck
    // -----------------------------
    async function importDeck() {
      const text = deckInput.value.trim();
      if (!text) {
        statusEl.textContent = 'Nothing to import.';
        statusEl.className = 'status-line error';
        return;
      }

      statusEl.textContent = 'Parsing deck…';
      statusEl.className = 'status-line';

      const entries = parseDeckText(text);

      if (entries.length === 0) {
        statusEl.textContent = 'No valid deck lines found.';
        statusEl.className = 'status-line error';
        return;
      }

      // Group by (name|set|number) key to avoid duplicate Scryfall calls
      const grouped = new Map();
      for (const e of entries) {
        const key = [e.name.toLowerCase(), e.set?.toLowerCase() || '', e.number || ''].join('|');
        if (!grouped.has(key)) {
          grouped.set(key, { ...e });
        } else {
          grouped.get(key).qty += e.qty;
        }
      }

      state.cards = [];

      let resolvedCount = 0;
      const totalToResolve = grouped.size;

      for (const [key, entry] of grouped.entries()) {
        try {
          statusEl.textContent = `Resolving card ${++resolvedCount} of ${totalToResolve}…`;
          const card = await resolveCardFromScryfall(entry);
          // Build internal card object
          const isLand = (card.type_line || '').toLowerCase().includes('land');
          const rulesMV = typeof card.cmc === 'number' ? card.cmc : 0;
          const effectiveMV = isLand ? 0 : Math.round(rulesMV);

          const colors = Array.isArray(card.color_identity)
            ? card.color_identity
            : [];

          const image =
            card.image_uris?.normal ||
            card.image_uris?.large ||
            card.image_uris?.png ||
            (card.card_faces && card.card_faces[0]?.image_uris?.normal) ||
            '';

          state.cards.push({
            id: key,
            name: card.name,
            qty: entry.qty,
            rulesMV,
            mv: effectiveMV,
            mvOverride: null,
            typeLine: card.type_line || '',
            colors,
            isLand,
            image,
            set: card.set?.toUpperCase() || entry.set,
            number: card.collector_number || entry.number || '',
          });
        } catch (e) {
          console.error('Failed to resolve card', entry, e);
          showToast(`Could not resolve "${entry.name}" – check spelling.`, true);
        }
      }

      // Sort by mana value, non-lands first, then lands
      sortDeckByMV();

      renderDeckTable();
      renderSummary();
      statusEl.textContent = `Imported ${state.cards.length} unique card(s).`;
      statusEl.className = 'status-line success';
      showToast('Deck imported and analyzed.');
    }

    function sortDeckByMV() {
      state.cards.sort((a, b) => {
        if (a.isLand && !b.isLand) return 1;
        if (!a.isLand && b.isLand) return -1;
        const mvA = a.mvOverride ?? a.mv;
        const mvB = b.mvOverride ?? b.mv;
        if (mvA !== mvB) return mvA - mvB;
        return a.name.localeCompare(b.name);
      });
    }

    // -----------------------------
    // Render deck table
    // -----------------------------
    function renderDeckTable() {
      deckTableBody.innerHTML = '';
      if (state.cards.length === 0) {
        deckFooterInfo.textContent = 'No deck loaded.';
        return;
      }

      for (const card of state.cards) {
        const tr = document.createElement('tr');

        // Qty
        const tdQty = document.createElement('td');
        const qtyWrap = document.createElement('div');
        qtyWrap.className = 'qty-control';
        const btnMinus = document.createElement('button');
        btnMinus.className = 'qty-button';
        btnMinus.textContent = '–';
        btnMinus.addEventListener('click', () => {
          if (card.qty > 1) {
            card.qty -= 1;
          } else {
            // remove card entirely
            state.cards = state.cards.filter(c => c.id !== card.id);
          }
          sortDeckByMV();
          renderDeckTable();
          renderSummary();
        });
        const qtyValue = document.createElement('span');
        qtyValue.className = 'qty-value';
        qtyValue.textContent = card.qty;
        const btnPlus = document.createElement('button');
        btnPlus.className = 'qty-button';
        btnPlus.textContent = '+';
        btnPlus.addEventListener('click', () => {
          card.qty += 1;
          sortDeckByMV();
          renderDeckTable();
          renderSummary();
        });
        qtyWrap.appendChild(btnMinus);
        qtyWrap.appendChild(qtyValue);
        qtyWrap.appendChild(btnPlus);
        tdQty.appendChild(qtyWrap);
        tr.appendChild(tdQty);

        // Card
        const tdCard = document.createElement('td');
        const cardCell = document.createElement('div');
        cardCell.className = 'card-name-cell';
        const cardNameSpan = document.createElement('span');
        cardNameSpan.className = 'card-name';
        cardNameSpan.textContent = card.name;
        const typePill = document.createElement('span');
        typePill.className = 'card-type-pill' + (card.isLand ? ' land-pill' : '');
        typePill.textContent = card.isLand ? 'Land' : (card.typeLine.split('—')[0].trim());
        cardCell.appendChild(cardNameSpan);
        cardCell.appendChild(typePill);
        cardCell.addEventListener('click', () => openCardModal(card.id));
        tdCard.appendChild(cardCell);
        tr.appendChild(tdCard);

        // Type
        const tdType = document.createElement('td');
        tdType.textContent = card.typeLine.split('—')[0].trim();
        tr.appendChild(tdType);

        // MV
        const tdMV = document.createElement('td');
        const mvChip = document.createElement('span');
        mvChip.className = 'mv-chip';
        const labelSpan = document.createElement('span');
        labelSpan.className = 'label';
        labelSpan.textContent = 'MV';
        const valSpan = document.createElement('span');
        valSpan.textContent = (card.mvOverride ?? card.mv).toString();
        mvChip.appendChild(labelSpan);
        mvChip.appendChild(valSpan);
        tdMV.appendChild(mvChip);
        tr.appendChild(tdMV);

        // Colors
        const tdColors = document.createElement('td');
        const colorsWrap = document.createElement('div');
        colorsWrap.className = 'color-dots';
        if (card.colors.length === 0) {
          const dot = document.createElement('div');
          dot.className = 'color-dot cC';
          colorsWrap.appendChild(dot);
        } else {
          for (const c of card.colors) {
            const dot = document.createElement('div');
            dot.className = 'color-dot c' + c;
            colorsWrap.appendChild(dot);
          }
        }
        tdColors.appendChild(colorsWrap);
        tr.appendChild(tdColors);

        deckTableBody.appendChild(tr);
      }

      const totalCards = state.cards.reduce((sum, c) => sum + c.qty, 0);
      const lands = state.cards.reduce((sum, c) => sum + (c.isLand ? c.qty : 0), 0);
      const spells = totalCards - lands;

      deckFooterInfo.innerHTML =
        `<strong>${totalCards}</strong> cards – <strong>${lands}</strong> lands, <strong>${spells}</strong> spells.`;
    }

    // -----------------------------
    // Summary (curve + counts)
    // -----------------------------
    function renderSummary() {
      renderCurve();
      renderCounts();
    }

    function renderCurve() {
      summaryCurve.innerHTML = '';

      if (state.cards.length === 0) {
        summaryCurve.textContent = 'No deck loaded.';
        return;
      }

      // Compute MV distribution for spells only
      const maxMV = 10;
      const counts = new Array(maxMV + 1).fill(0);
      for (const card of state.cards) {
        if (card.isLand) continue;
        const mv = card.mvOverride ?? card.mv;
        const bucket = Math.max(0, Math.min(maxMV, mv));
        counts[bucket] += card.qty;
      }
      const maxCount = Math.max(1, ...counts);

      for (let mv = 0; mv <= maxMV; mv++) {
        const row = document.createElement('div');
        row.className = 'curve-row';

        const label = document.createElement('div');
        label.className = 'curve-label';
        label.textContent = mv.toString();
        row.appendChild(label);

        const barWrap = document.createElement('div');
        barWrap.className = 'curve-bar-wrap';
        const bar = document.createElement('div');
        bar.className = 'curve-bar';
        bar.style.width = (counts[mv] / maxCount * 100).toFixed(1) + '%';
        barWrap.appendChild(bar);
        row.appendChild(barWrap);

        const countLabel = document.createElement('div');
        countLabel.className = 'curve-count';
        countLabel.textContent = counts[mv] > 0 ? counts[mv] : '';
        row.appendChild(countLabel);

        summaryCurve.appendChild(row);
      }

      const totalCards = state.cards.reduce((sum, c) => sum + c.qty, 0);
      const lands = state.cards.reduce((sum, c) => sum + (c.isLand ? c.qty : 0), 0);
      const spells = totalCards - lands;

      const infoLine = document.createElement('div');
      infoLine.className = 'summary-line';
      infoLine.innerHTML =
        `<span>Total cards: <strong>${totalCards}</strong></span>` +
        `<span>Lands: <strong>${lands}</strong> – Spells: <strong>${spells}</strong></span>`;
      summaryCurve.appendChild(infoLine);
    }

    function renderCounts() {
      summaryCounts.innerHTML = '';
      if (state.cards.length === 0) {
        summaryCounts.textContent = 'No deck loaded.';
        return;
      }

      const total = state.cards.reduce((sum, c) => sum + c.qty, 0);
      const lands = state.cards.reduce((sum, c) => sum + (c.isLand ? c.qty : 0), 0);
      const spells = total - lands;

      const p1 = document.createElement('div');
      p1.className = 'summary-line';
      p1.innerHTML = `<span>Total cards</span><span><strong>${total}</strong></span>`;
      summaryCounts.appendChild(p1);

      const p2 = document.createElement('div');
      p2.className = 'summary-line';
      p2.innerHTML = `<span>Lands</span><span><strong>${lands}</strong></span>`;
      summaryCounts.appendChild(p2);

      const p3 = document.createElement('div');
      p3.className = 'summary-line';
      p3.innerHTML = `<span>Spells</span><span><strong>${spells}</strong></span>`;
      summaryCounts.appendChild(p3);

      // Color counts (by color identity)
      const colorCounts = { W: 0, U: 0, B: 0, R: 0, G: 0, C: 0 };
      for (const card of state.cards) {
        const nonLandQty = card.isLand ? 0 : card.qty;
        if (nonLandQty === 0) continue;
        if (card.colors.length === 0) {
          colorCounts.C += nonLandQty;
        } else {
          for (const c of card.colors) {
            colorCounts[c] += nonLandQty;
          }
        }
      }

      const p4 = document.createElement('div');
      p4.className = 'summary-line';
      p4.innerHTML = `<span>Color weight (spells)</span><span></span>`;
      summaryCounts.appendChild(p4);

      const colorsRow = document.createElement('div');
      colorsRow.style.display = 'flex';
      colorsRow.style.flexWrap = 'wrap';
      colorsRow.style.gap = '6px';
      colorsRow.style.marginTop = '4px';

      for (const c of ['W', 'U', 'B', 'R', 'G', 'C']) {
        const val = colorCounts[c];
        const pill = document.createElement('span');
        pill.className = 'pill-tag';
        pill.innerHTML = `<strong>${c}</strong>: ${val}`;
        colorsRow.appendChild(pill);
      }
      summaryCounts.appendChild(colorsRow);
    }

    // -----------------------------
    // Card modal (MV override, details)
    // -----------------------------
    function openCardModal(cardId) {
      const card = state.cards.find(c => c.id === cardId);
      if (!card) return;
      modalCardId = cardId;

      modalArt.src = card.image || '';
      modalArt.alt = card.name;
      modalPrintInfo.textContent = card.set
        ? `${card.set} #${card.number || '?'}` : '';

      modalTitle.textContent = card.name;
      modalType.textContent = card.typeLine;

      modalRulesMV.textContent = card.rulesMV.toString();
      modalMVOverride.value = card.mvOverride != null ? card.mvOverride : '';

      modalDeckQty.textContent = card.qty.toString();

      cardModal.classList.add('show');
    }

    function closeCardModal(save = true) {
      if (save && modalCardId) {
        const card = state.cards.find(c => c.id === modalCardId);
        if (card) {
          const raw = modalMVOverride.value.trim();
          if (raw === '') {
            card.mvOverride = null;
          } else {
            const val = parseInt(raw, 10);
            if (!isNaN(val) && val >= 0) {
              card.mvOverride = val;
            }
          }
          // re-sort and redraw
          sortDeckByMV();
          renderDeckTable();
          renderSummary();
        }
      }
      modalCardId = null;
      cardModal.classList.remove('show');
    }

    modalCloseBtn.addEventListener('click', () => closeCardModal(true));
    cardModal.addEventListener('click', (e) => {
      if (e.target === cardModal) {
        closeCardModal(true);
      }
    });

    // -----------------------------
    // Builder minimal add
    // -----------------------------
    const builderName = document.getElementById('builderName');
    const builderQty = document.getElementById('builderQty');
    const builderAdd = document.getElementById('builderAdd');

    builderAdd.addEventListener('click', async () => {
      const name = builderName.value.trim();
      const qty = parseInt(builderQty.value, 10) || 1;
      if (!name) {
        showToast('Enter a card name first.', true);
        return;
      }
      try {
        statusEl.textContent = `Resolving "${name}"…`;
        statusEl.className = 'status-line';
        const cardData = await resolveCardFromScryfall({ name, set: null, number: null });
        const key = [cardData.name.toLowerCase(), cardData.set || '', cardData.collector_number || ''].join('|');
        const existing = state.cards.find(c => c.id === key);
        if (existing) {
          existing.qty += qty;
        } else {
          const isLand = (cardData.type_line || '').toLowerCase().includes('land');
          const rulesMV = typeof cardData.cmc === 'number' ? cardData.cmc : 0;
          const effectiveMV = isLand ? 0 : Math.round(rulesMV);
          const colors = Array.isArray(cardData.color_identity)
            ? cardData.color_identity
            : [];
          const image =
            cardData.image_uris?.normal ||
            cardData.image_uris?.large ||
            cardData.image_uris?.png ||
            (cardData.card_faces && cardData.card_faces[0]?.image_uris?.normal) ||
            '';
          state.cards.push({
            id: key,
            name: cardData.name,
            qty,
            rulesMV,
            mv: effectiveMV,
            mvOverride: null,
            typeLine: cardData.type_line || '',
            colors,
            isLand,
            image,
            set: cardData.set?.toUpperCase() || '',
            number: cardData.collector_number || '',
          });
        }
        sortDeckByMV();
        renderDeckTable();
        renderSummary();
        statusEl.textContent = 'Card added via builder.';
        statusEl.className = 'status-line success';
        showToast(`Added ${qty}× ${name}.`);
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Error adding card.';
        statusEl.className = 'status-line error';
        showToast('Could not resolve that card name.', true);
      }
    });

    // -----------------------------
    // Event wiring
    // -----------------------------
    importButton.addEventListener('click', () => {
      importDeck().catch(err => {
        console.error(err);
        statusEl.textContent = 'Error importing deck.';
        statusEl.className = 'status-line error';
      });
    });

    clearButton.addEventListener('click', () => {
      deckInput.value = '';
      state.cards = [];
      deckTableBody.innerHTML = '';
      summaryCurve.innerHTML = '';
      summaryCounts.innerHTML = '';
      deckFooterInfo.textContent = 'No deck loaded.';
      statusEl.textContent = '';
    });
  </script>
</body>
</html>
